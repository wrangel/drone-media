<!doctype html>
<html>
	<head>
		<!-- for optimal display on high DPI devices -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css" />
		<link rel="stylesheet" href="css/pano-viewer.css">
		<link rel="icon" type="image/x-icon" href="media/icons/favicon/favicon.ico">
		
		<script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.js"></script>
		<script src=" https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/autorotate-plugin@5.1.1/index.min.js "></script>
	</head>
	
	<body>
		<div class="outer-box">
			<!-- the viewer container must have a defined size -->
			<div id="viewer"></div>
		</div>

		<script>
			const img = window.location.search.split('=')[1];
			
			const animatedValues = {
				pitch: { start: -Math.PI / 2, end: 0.2 },
				yaw: { start: Math.PI, end: 0 },
				zoom: { start: 0, end: 50 },
				fisheye: { start: 2, end: 0 },
			};
			
			const viewer = new PhotoSphereViewer.Viewer({
				container: document.querySelector('#viewer'),
				panorama: '../media/pano/' + img + '.jpeg',
				maxFov: 110, // 90, zoom out
				minFov: 10, // 30, zoom in
				defaultZoomLvl: 50,
				defaultPitch: animatedValues.pitch.start,
				defaultYaw: animatedValues.yaw.start,
				defaultZoomLvl: animatedValues.zoom.start,
				fisheye: animatedValues.fisheye.start,
				navbar: [
					'zoom',
					'fullscreen',
					{
						title: 'Rerun animation',
						content: 'ðŸ”„',
						onClick: intro,
					},
					{ // create custom button for fisheye
						id: 'fisheye',
						content: 'F',
						title: 'Fisheye View',
						className: 'fisheye-button',
						onClick: (viewer) => {
							viewer.setOptions({
								fisheye: true,
								maxFov: 150,
							});
						},
					},
					{ // create custom button for panorama
						id: 'panorama',
						content: 'P',
						title: 'Panorama View',
						className: 'panorama-button',
						onClick: (viewer) => {
							viewer.setOptions({
								fisheye: false,
							});
						},
					},
				],
				plugins: [
					[PhotoSphereViewer.AutorotatePlugin, {
						autostartDelay: null,
						autostartOnIdle: false,
						autorotatePitch: animatedValues.pitch.end,
					}],
				],
			});
			
			const autorotate = viewer.getPlugin(PhotoSphereViewer.AutorotatePlugin);

			viewer.addEventListener('ready', intro, { once: true });
			
			function intro() {
				autorotate.stop();

				new PhotoSphereViewer.utils.Animation({
					properties: animatedValues,
					duration: 3000,
					easing: 'inOutQuad',
					onTick: (properties) => {
						viewer.setOption('fisheye', properties.fisheye);
						viewer.rotate({ yaw: properties.yaw, pitch: properties.pitch });
						viewer.zoom(properties.zoom);
					},
				}).then(() => {
					autorotate.start();
				});
			}
			
			// Clean up cache
			window.addEventListener('beforeunload', function () {
            	viewer.destroy();
        	});	
			
		</script>
	</body>
</html>
